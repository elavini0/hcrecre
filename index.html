<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historia Clínica Digital - Recrearte</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
/* Reset y configuración base */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    min-height: 100vh;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    min-height: 100vh;
    box-shadow: 0 0 20px rgba(0,0,0,0.1);
}

/* Header */
.header {
    background: linear-gradient(135deg, #00bcd4 0%, #4caf50 25%, #ff9800 50%, #f44336 75%, #9c27b0 100%);
    padding: 20px;
    color: white;
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
}

.header > * {
    position: relative;
    z-index: 2;
}

.logo-section {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 15px;
}

.logo-recrearte {
    display: flex;
    align-items: center;
    gap: 20px;
}

.logo-image {
    height: 60px;
    width: auto;
    filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
}

.page-title {
    font-size: 24px;
    font-weight: 400;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    color: white;
}

.date-section {
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
}

.date-section label {
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 10px;
}

.date-section input {
    padding: 8px 12px;
    border: none;
    border-radius: 5px;
    font-size: 14px;
}

.btn-clear {
    background: #dc3545;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-clear:hover {
    background: #c82333;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(220,53,69,0.3);
}

/* Progress Bar */
.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #4caf50, #00bcd4);
    width: 8.33%;
    transition: width 0.3s ease;
    border-radius: 4px;
}

/* Main Content */
.main-content {
    display: flex;
    min-height: calc(100vh - 200px);
}

/* Sidebar */
.sidebar {
    width: 280px;
    background: #f8f9fa;
    border-right: 1px solid #e9ecef;
    position: relative;
}

.nav-toggle {
    display: none;
    padding: 15px;
    cursor: pointer;
    font-size: 20px;
    background: #007bff;
    color: white;
    text-align: center;
}

.nav-menu {
    list-style: none;
    padding: 20px 0;
}

.nav-menu li {
    margin: 0;
}

.nav-link {
    display: block;
    padding: 12px 20px;
    text-decoration: none;
    color: #495057;
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
}

.nav-link:hover {
    background: #e9ecef;
    color: #007bff;
    border-left-color: #007bff;
}

.nav-link.active {
    background: #007bff;
    color: white;
    border-left-color: #0056b3;
}

/* Form Content */
.form-content {
    flex: 1;
    padding: 30px;
    overflow-y: auto;
}

.form-section {
    display: none;
    animation: fadeIn 0.3s ease;
}

.form-section.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.form-section h3 {
    color: #007bff;
    margin-bottom: 25px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
    font-size: 24px;
}

.form-section h4 {
    color: #495057;
    margin: 20px 0 15px 0;
    font-size: 18px;
}

/* Form Groups */
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #495057;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    outline: none;
    border-color: #007bff;
    box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
}

.form-group input:required:invalid {
    border-color: #dc3545;
}

.form-group input:required:valid {
    border-color: #28a745;
}

/* Grid Layouts */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.vitales-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
}

.antropometria-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

/* Radio Groups */
.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.radio-group label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: normal;
    cursor: pointer;
}

/* Table Styles */
.table-container {
    overflow-x: auto;
    margin: 20px 0;
}

#grupoFamiliarTable {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 15px;
}

#grupoFamiliarTable th,
#grupoFamiliarTable td {
    padding: 12px;
    text-align: left;
    border: 1px solid #e9ecef;
}

#grupoFamiliarTable th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

#grupoFamiliarTable input {
    width: 100%;
    padding: 8px;
    border: 1px solid #e9ecef;
    border-radius: 4px;
}

/* Buttons */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
}

.btn-primary {
    background: #007bff;
    color: white;
}

.btn-primary:hover {
    background: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #545b62;
    transform: translateY(-2px);
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #1e7e34;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(40,167,69,0.3);
}

.btn-add {
    background: #28a745;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.btn-add:hover {
    background: #1e7e34;
}

.btn-remove {
    background: #dc3545;
    color: white;
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
}

.btn-remove:hover {
    background: #c82333;
}

/* Navigation Buttons */
.navigation-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 40px;
    padding-top: 20px;
    border-top: 1px solid #e9ecef;
}

/* Examen Subsections */
.examen-subsection {
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #007bff;
}

/* Firma Section */
.firma-section {
    margin-top: 40px;
    text-align: right;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.firma {
    font-size: 16px;
    color: #495057;
    line-height: 1.4;
}

/* Responsive Design */
@media (max-width: 768px) {
    .main-content {
        flex-direction: column;
    }
    
    .sidebar {
        width: 100%;
        position: relative;
    }
    
    .nav-toggle {
        display: block;
    }
    
    .nav-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #f8f9fa;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .nav-menu.show {
        display: block;
    }
    
    .form-content {
        padding: 20px;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
    
    .vitales-grid,
    .antropometria-grid {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    }
    
    .navigation-buttons {
        flex-direction: column;
        gap: 10px;
    }
    
    .logo-section {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .page-title {
        font-size: 20px;
    }
}

@media (max-width: 480px) {
    .form-content {
        padding: 15px;
    }
    
    .header {
        padding: 15px;
    }
    
    .logo-text {
        font-size: 24px;
    }
    
    .page-title {
        font-size: 18px;
    }
    
    .table-container {
        font-size: 12px;
    }
    
    #grupoFamiliarTable th,
    #grupoFamiliarTable td {
        padding: 8px;
    }
}

/* Print Styles */
@media print {
    .sidebar,
    .navigation-buttons,
    .nav-toggle {
        display: none;
    }
    
    .main-content {
        flex-direction: column;
    }
    
    .form-content {
        padding: 0;
    }
    
    .form-section {
        display: block !important;
        page-break-inside: avoid;
        margin-bottom: 30px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo-section">
                <div class="logo-recrearte">
                    <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px;">R</div>
                    <h2 class="page-title">Historia Clínica Digital - Recrearte</h2>
                </div>
            </div>
            <div class="date-section">
                <label>Fecha: <input type="date" id="fecha" required></label>
                <button type="button" id="clearFormBtn" class="btn-clear">🗑️ Limpiar Formulario</button>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </header>

        <div class="main-content">
            <!-- Sidebar Navigation -->
            <nav class="sidebar" id="sidebar">
                <div class="nav-toggle" id="navToggle">☰</div>
                <ul class="nav-menu" id="navMenu">
                    <li><a href="#seccion1" class="nav-link active" data-section="1">Datos Personales</a></li>
                    <li><a href="#seccion2" class="nav-link" data-section="2">Equipo Médico</a></li>
                    <li><a href="#seccion3" class="nav-link" data-section="3">Grupo Familiar</a></li>
                    <li><a href="#seccion4" class="nav-link" data-section="4">Antecedentes</a></li>
                    <li><a href="#seccion5" class="nav-link" data-section="5">Laboral/Educativo</a></li>
                    <li><a href="#seccion6" class="nav-link" data-section="6">Vida Cotidiana</a></li>
                    <li><a href="#seccion7" class="nav-link" data-section="7">Medicamentos</a></li>
                    <li><a href="#seccion8" class="nav-link" data-section="8">Control</a></li>
                    <li><a href="#seccion9" class="nav-link" data-section="9">Datos Vitales</a></li>
                    <li><a href="#seccion10" class="nav-link" data-section="10">Antropometría</a></li>
                    <li><a href="#seccion11" class="nav-link" data-section="11">Examen</a></li>
                    <li><a href="#seccion12" class="nav-link" data-section="12">Evaluación</a></li>
                </ul>
            </nav>

            <!-- Form Content -->
            <main class="form-content">
                <form id="historiaClinicaForm">


                    
                    <!-- Sección 1: Datos Personales -->
                    <section class="form-section active" id="seccion1">
                        <h3>Datos Personales</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="nombreApellido">Nombre y Apellido *</label>
                                <input type="text" id="nombreApellido" name="nombreApellido" required>
                            </div>
                            <div class="form-group">
                                <label for="fechaNacimiento">Fecha de Nacimiento *</label>
                                <input type="date" id="fechaNacimiento" name="fechaNacimiento" required>
                            </div>
                            <div class="form-group">
                                <label for="edad">Edad</label>
                                <input type="number" id="edad" name="edad" readonly>
                            </div>
                            <div class="form-group">
                                <label for="dni">DNI *</label>
                                <input type="text" id="dni" name="dni" required>
                            </div>
                            <div class="form-group">
                                <label for="lugarNacimiento">Lugar de Nacimiento</label>
                                <input type="text" id="lugarNacimiento" name="lugarNacimiento">
                            </div>
                            <div class="form-group full-width">
                                <label for="direccionActual">Dirección Actual *</label>
                                <input type="text" id="direccionActual" name="direccionActual" required>
                            </div>
                            <div class="form-group">
                                <label for="telefono">Teléfono de Referencia *</label>
                                <input type="tel" id="telefono" name="telefono" required>
                            </div>
                        </div>
                    </section>

                    <!-- Sección 2: Equipo Médico -->
                    <section class="form-section" id="seccion2">
                        <h3>Equipo y/o Médicos de Referencia</h3>
                        <div class="form-group">
                            <textarea id="equipoMedico" name="equipoMedico" rows="4" placeholder="Ingrese información sobre el equipo médico de referencia..."></textarea>
                        </div>
                    </section>

                    <!-- Sección 3: Grupo Familiar -->
                    <section class="form-section" id="seccion3">
                        <h3>Integrantes del Grupo Familiar</h3>
                        <div class="table-container">
                            <table id="grupoFamiliarTable">
                                <thead>
                                    <tr>
                                        <th>N°</th>
                                        <th>Apellido y Nombre</th>
                                        <th>Dirección</th>
                                        <th>Teléfono</th>
                                        <th>Referencia</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="grupoFamiliarBody">
                                    <tr>
                                        <td>1</td>
                                        <td><input type="text" name="familiar_nombre_1"></td>
                                        <td><input type="text" name="familiar_direccion_1"></td>
                                        <td><input type="tel" name="familiar_telefono_1"></td>
                                        <td><input type="text" name="familiar_referencia_1"></td>
                                        <td><button type="button" class="btn-remove" onclick="removeRow(this)">-</button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button type="button" class="btn-add" onclick="addFamiliarRow()">+ Agregar Familiar</button>
                        </div>
                    </section>

                    <!-- Sección 4: Antecedentes -->
                    <section class="form-section" id="seccion4">
                        <h3>Antecedentes</h3>
                        <div class="form-group">
                            <label for="antecedentesFamiliares">Antecedentes Familiares de Relevancia</label>
                            <textarea id="antecedentesFamiliares" name="antecedentesFamiliares" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="antecedentesPersonales">Antecedentes Personales (patológicos, quirúrgicos, ginecológicos, de relevancia)</label>
                            <textarea id="antecedentesPersonales" name="antecedentesPersonales" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="intoleranciaMedicamentos">Intolerancias a Medicamentos</label>
                            <textarea id="intoleranciaMedicamentos" name="intoleranciaMedicamentos" rows="3"></textarea>
                        </div>
                    </section>

                    <!-- Sección 5: Laboral y Educativo -->
                    <section class="form-section" id="seccion5">
                        <h3>Información Laboral y Educativa</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="ocupacion">Ocupación</label>
                                <input type="text" id="ocupacion" name="ocupacion">
                            </div>
                            <div class="form-group">
                                <label for="educacion">Educación</label>
                                <input type="text" id="educacion" name="educacion">
                            </div>
                        </div>
                    </section>

                    <!-- Sección 6: Vida Cotidiana -->
                    <section class="form-section" id="seccion6">
                        <h3>Datos de la Vida Cotidiana</h3>
                        <div class="form-group">
                            <label for="alimentacion">Alimentación (requerimientos, dieta, aportes)</label>
                            <textarea id="alimentacion" name="alimentacion" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="sueno">Sueño</label>
                            <textarea id="sueno" name="sueno" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="actividadFisica">Actividad Física</label>
                            <textarea id="actividadFisica" name="actividadFisica" rows="3"></textarea>
                        </div>
                    </section>

                    <!-- Sección 7: Medicamentos y Vacunas -->
                    <section class="form-section" id="seccion7">
                        <h3>Medicamentos y Vacunas</h3>
                        <div class="form-group">
                            <label for="esquemaVacunas">Esquema de Aplicación de Vacunas</label>
                            <textarea id="esquemaVacunas" name="esquemaVacunas" rows="3" placeholder="Adjuntar información de vacunas aplicadas..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="indicacionesMedicamentos">Indicaciones de Medicamentos</label>
                            <textarea id="indicacionesMedicamentos" name="indicacionesMedicamentos" rows="3"></textarea>
                        </div>
                    </section>

                    <!-- Sección 8: Control y Seguimiento -->
                    <section class="form-section" id="seccion8">
                        <h3>Control y Seguimiento</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="fechaControl">Fecha de Control</label>
                                <input type="date" id="fechaControl" name="fechaControl">
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" id="telefonico" name="telefonico">
                                    Telefónico
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Tipo de Control:</label>
                            <div class="radio-group">
                                <label><input type="radio" name="tipoControl" value="familiar"> Familiar</label>
                                <label><input type="radio" name="tipoControl" value="personal"> Personal</label>
                            </div>
                        </div>
                    </section>

                    <!-- Sección 9: Datos Vitales -->
                    <section class="form-section" id="seccion9">
                        <h3>Datos Vitales</h3>
                        <div class="vitales-grid">
                            <div class="form-group">
                                <label for="ta">TA</label>
                                <input type="text" id="ta" name="ta" placeholder="120/80">
                            </div>
                            <div class="form-group">
                                <label for="temperatura">T (°C)</label>
                                <input type="number" id="temperatura" name="temperatura" step="0.1" placeholder="36.5">
                            </div>
                            <div class="form-group">
                                <label for="fr">FR</label>
                                <input type="number" id="fr" name="fr" placeholder="20">
                            </div>
                            <div class="form-group">
                                <label for="fc">FC</label>
                                <input type="number" id="fc" name="fc" placeholder="80">
                            </div>
                            <div class="form-group">
                                <label for="satO2">SAT O2 (%)</label>
                                <input type="number" id="satO2" name="satO2" min="0" max="100" placeholder="98">
                            </div>
                        </div>
                    </section>

                    <!-- Sección 10: Antropometría -->
                    <section class="form-section" id="seccion10">
                        <h3>Antropometría</h3>
                        <div class="antropometria-grid">
                            <div class="form-group">
                                <label for="peso">Peso (kg)</label>
                                <input type="number" id="peso" name="peso" step="0.1" placeholder="70.0">
                            </div>
                            <div class="form-group">
                                <label for="talla">Talla (cm)</label>
                                <input type="number" id="talla" name="talla" step="0.1" placeholder="170.0">
                            </div>
                            <div class="form-group">
                                <label for="imc">IMC</label>
                                <input type="number" id="imc" name="imc" step="0.01" readonly>
                            </div>
                            <div class="form-group">
                                <label for="pc">PC (cm)</label>
                                <input type="number" id="pc" name="pc" step="0.1" placeholder="90.0">
                            </div>
                        </div>
                    </section>

                    <!-- Sección 11: Examen por Aparatos -->
                    <section class="form-section" id="seccion11">
                        <h3>Examen por Aparatos</h3>
                        
                        <div class="examen-subsection">
                            <h4>1. Desarrollo Psicomotriz</h4>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="motricidad">Motricidad</label>
                                    <textarea id="motricidad" name="motricidad" rows="2"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="lenguaje">Lenguaje</label>
                                    <textarea id="lenguaje" name="lenguaje" rows="2"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="conductaSocial">Conducta Social</label>
                                    <textarea id="conductaSocial" name="conductaSocial" rows="2"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="examen-subsection">
                            <h4>2. Piel y Faneras</h4>
                            <div class="form-group">
                                <textarea id="pielFaneras" name="pielFaneras" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="examen-subsection">
                            <h4>3. Audición</h4>
                            <div class="form-group">
                                <textarea id="audicion" name="audicion" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="examen-subsection">
                            <h4>4. Visión</h4>
                            <div class="form-group">
                                <textarea id="vision" name="vision" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="examen-subsection">
                            <h4>5. Pulmonar</h4>
                            <div class="form-group">
                                <textarea id="pulmonar" name="pulmonar" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="examen-subsection">
                            <h4>6. Cardíaco</h4>
                            <div class="form-group">
                                <textarea id="cardiaco" name="cardiaco" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="examen-subsection">
                            <h4>7. Abdominal</h4>
                            <div class="form-group">
                                <textarea id="abdominal" name="abdominal" rows="2"></textarea>
                            </div>
                        </div>

                        <div class="examen-subsection">
                            <h4>8. MMSS - MMII</h4>
                            <div class="form-group">
                                <textarea id="mmssmmii" name="mmssmmii" rows="2"></textarea>
                            </div>
                        </div>
                    </section>

                    <!-- Sección 12: Evaluación Final -->
                    <section class="form-section" id="seccion12">
                        <h3>Evaluación Final</h3>
                        <div class="form-group">
                            <label for="evaluacionGeneral">Evaluación General</label>
                            <textarea id="evaluacionGeneral" name="evaluacionGeneral" rows="4"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="recomendaciones">Recomendaciones</label>
                            <textarea id="recomendaciones" name="recomendaciones" rows="4"></textarea>
                        </div>
                        
                        <div class="firma-section">
                            <div class="firma">
                                Milagros Quilici<br>
                                <strong>MÉDICA</strong>
                            </div>
                        </div>
                    </section>

                    <!-- Navigation Buttons -->
                    <div class="navigation-buttons">
                        <button type="button" id="prevBtn" class="btn btn-secondary">Anterior</button>
                        <button type="button" id="generatePdfBtn" class="btn btn-success">Generar PDF</button>
                        <button type="button" id="nextBtn" class="btn btn-primary">Siguiente</button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <script>
// Variables globales
let currentSection = 1;
const totalSections = 12;
let familiarRowCount = 1;

// Inicialización cuando se carga la página
document.addEventListener('DOMContentLoaded', function() {
    initializeForm();
    setupEventListeners();
    updateProgress();
    
    // Establecer fecha actual
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fecha').value = today;
    
    // Cargar datos guardados si existen
    loadFormData();
});

// Configurar event listeners
function setupEventListeners() {
    // Navegación
    document.getElementById('prevBtn').addEventListener('click', previousSection);
    document.getElementById('nextBtn').addEventListener('click', nextSection);
    document.getElementById('generatePdfBtn').addEventListener('click', generatePDF);
    document.getElementById('clearFormBtn').addEventListener('click', clearForm);
    
    // Navegación por menú lateral
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const sectionNumber = parseInt(this.dataset.section);
            goToSection(sectionNumber);
        });
    });
    
    // Toggle menú móvil
    document.getElementById('navToggle').addEventListener('click', function() {
        const navMenu = document.getElementById('navMenu');
        navMenu.classList.toggle('show');
    });
    
    // Cálculo automático de edad
    document.getElementById('fechaNacimiento').addEventListener('change', calculateAge);
    
    // Cálculo automático de IMC
    document.getElementById('peso').addEventListener('input', calculateIMC);
    document.getElementById('talla').addEventListener('input', calculateIMC);
    
    // Auto-guardado
    const formInputs = document.querySelectorAll('input, textarea, select');
    formInputs.forEach(input => {
        input.addEventListener('change', saveFormData);
        input.addEventListener('input', debounce(saveFormData, 1000));
    });
}

// Inicializar formulario
function initializeForm() {
    showSection(currentSection);
    updateNavigationButtons();
}

// Mostrar sección específica
function showSection(sectionNumber) {
    // Ocultar todas las secciones
    const sections = document.querySelectorAll('.form-section');
    sections.forEach(section => section.classList.remove('active'));
    
    // Mostrar sección actual
    const currentSectionElement = document.getElementById(`seccion${sectionNumber}`);
    if (currentSectionElement) {
        currentSectionElement.classList.add('active');
    }
    
    // Actualizar navegación lateral
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.classList.remove('active');
        if (parseInt(link.dataset.section) === sectionNumber) {
            link.classList.add('active');
        }
    });
    
    currentSection = sectionNumber;
    updateProgress();
    updateNavigationButtons();
    
    // Scroll al top
    document.querySelector('.form-content').scrollTop = 0;
}

// Ir a sección específica
function goToSection(sectionNumber) {
    if (sectionNumber >= 1 && sectionNumber <= totalSections) {
        showSection(sectionNumber);
    }
}

// Sección anterior
function previousSection() {
    if (currentSection > 1) {
        showSection(currentSection - 1);
    }
}

// Sección siguiente
function nextSection() {
    if (currentSection < totalSections) {
        showSection(currentSection + 1);
    }
}

// Actualizar botones de navegación
function updateNavigationButtons() {
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const generatePdfBtn = document.getElementById('generatePdfBtn');
    
    prevBtn.style.display = currentSection === 1 ? 'none' : 'inline-block';
    
    if (currentSection === totalSections) {
        nextBtn.style.display = 'none';
        generatePdfBtn.style.display = 'inline-block';
    } else {
        nextBtn.style.display = 'inline-block';
        generatePdfBtn.style.display = 'none';
    }
}

// Actualizar barra de progreso
function updateProgress() {
    const progressFill = document.getElementById('progressFill');
    const percentage = (currentSection / totalSections) * 100;
    progressFill.style.width = percentage + '%';
}

// Calcular edad automáticamente
function calculateAge() {
    const birthDate = new Date(this.value);
    const today = new Date();
    
    if (birthDate && birthDate <= today && !isNaN(birthDate.getTime())) {
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        
        document.getElementById('edad').value = age;
    } else {
        document.getElementById('edad').value = '';
    }
}

// Calcular IMC automáticamente
function calculateIMC() {
    const peso = parseFloat(document.getElementById('peso').value);
    const talla = parseFloat(document.getElementById('talla').value);
    
    if (peso && talla) {
        const tallaMts = talla / 100;
        const imc = peso / (tallaMts * tallaMts);
        document.getElementById('imc').value = imc.toFixed(2);
    }
}

// Agregar fila a tabla familiar
function addFamiliarRow() {
    familiarRowCount++;
    const tbody = document.getElementById('grupoFamiliarBody');
    const newRow = document.createElement('tr');
    
    newRow.innerHTML = `
        <td>${familiarRowCount}</td>
        <td><input type="text" name="familiar_nombre_${familiarRowCount}"></td>
        <td><input type="text" name="familiar_direccion_${familiarRowCount}"></td>
        <td><input type="tel" name="familiar_telefono_${familiarRowCount}"></td>
        <td><input type="text" name="familiar_referencia_${familiarRowCount}"></td>
        <td><button type="button" class="btn-remove" onclick="removeRow(this)">-</button></td>
    `;
    
    tbody.appendChild(newRow);
    
    // Agregar event listeners a los nuevos campos
    const newInputs = newRow.querySelectorAll('input');
    newInputs.forEach(input => {
        input.addEventListener('change', saveFormData);
        input.addEventListener('input', debounce(saveFormData, 1000));
    });
}

// Remover fila de tabla familiar
function removeRow(button) {
    const row = button.closest('tr');
    row.remove();
    
    // Reordenar números
    const rows = document.querySelectorAll('#grupoFamiliarBody tr');
    rows.forEach((row, index) => {
        row.cells[0].textContent = index + 1;
        
        // Actualizar nombres de los inputs
        const inputs = row.querySelectorAll('input');
        inputs[0].name = `familiar_nombre_${index + 1}`;
        inputs[1].name = `familiar_direccion_${index + 1}`;
        inputs[2].name = `familiar_telefono_${index + 1}`;
        inputs[3].name = `familiar_referencia_${index + 1}`;
    });
    
    familiarRowCount = rows.length;
}

// Guardar datos del formulario en localStorage
function saveFormData() {
    const formData = new FormData(document.getElementById('historiaClinicaForm'));
    const data = {};
    
    for (let [key, value] of formData.entries()) {
        data[key] = value;
    }
    
    // Guardar también datos de radio buttons y checkboxes
    const radioButtons = document.querySelectorAll('input[type="radio"]:checked');
    radioButtons.forEach(radio => {
        data[radio.name] = radio.value;
    });
    
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        data[checkbox.name] = checkbox.checked;
    });
    
    localStorage.setItem('historiaClinicaData', JSON.stringify(data));
}

// Cargar datos del formulario desde localStorage
function loadFormData() {
    const savedData = localStorage.getItem('historiaClinicaData');
    if (savedData) {
        const data = JSON.parse(savedData);
        
        for (let [key, value] of Object.entries(data)) {
            const field = document.querySelector(`[name="${key}"]`);
            if (field) {
                if (field.type === 'checkbox') {
                    field.checked = value;
                } else if (field.type === 'radio') {
                    if (field.value === value) {
                        field.checked = true;
                    }
                } else {
                    field.value = value;
                }
            }
        }
    }
}

// Generar PDF
function generatePDF() {
    try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Configurar fuente
        doc.setFont('helvetica');
        
        let yPosition = 30;
        const pageHeight = doc.internal.pageSize.height;
        const marginLeft = 20;
        const marginRight = 20;
        const pageWidth = doc.internal.pageSize.width - marginLeft - marginRight;
        
        // Función para agregar nueva página si es necesario
        function checkPageBreak(neededSpace = 20) {
            if (yPosition + neededSpace > pageHeight - 40) {
                doc.addPage();
                yPosition = 30;
                addSimpleHeader();
            }
        }
        
                        // Función para agregar header simple
        function addSimpleHeader() {
            // Título del documento
            doc.setFontSize(18);
            doc.setTextColor('#007bff');
            doc.setFont('helvetica', 'bold');
            doc.text('HISTORIA CLÍNICA DIGITAL - RECREARTE', marginLeft, yPosition);
            
            // Fecha (en la siguiente línea)
            const fecha = document.getElementById('fecha').value;
            doc.setFontSize(12);
            doc.setTextColor('#000000');
            doc.setFont('helvetica', 'normal');
            doc.text(`Fecha: ${fecha}`, pageWidth - 40, yPosition + 15);
            
            // Línea separadora
            doc.setDrawColor('#e9ecef');
            doc.line(marginLeft, yPosition + 25, pageWidth, yPosition + 25);
            
            yPosition += 35;
        }


            
            // Fecha
            const fecha = document.getElementById('fecha').value;
            doc.setFontSize(12);
            doc.setTextColor('#000000');
            doc.setFont('helvetica', 'normal');
            doc.text(`Fecha: ${fecha}`, pageWidth - 30, yPosition);
            
            // Línea separadora
            doc.setDrawColor('#e9ecef');
            doc.line(marginLeft, yPosition + 10, pageWidth, yPosition + 10);
            
            yPosition += 25;
        }
        
        // Función para agregar sección
        function addSection(title, content) {
            checkPageBreak(30);
            
            // Título de sección
            doc.setFontSize(13);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor('#007bff');
            doc.text(title, marginLeft, yPosition);
            yPosition += 15;
            
            // Contenido
            doc.setTextColor('#000000');
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            if (typeof content === 'object') {
                Object.entries(content).forEach(([key, value]) => {
                    if (value) {
                        checkPageBreak();
                        const text = `${key}: ${value}`;
                        const lines = doc.splitTextToSize(text, pageWidth);
                        lines.forEach(line => {
                            doc.text(line, marginLeft, yPosition);
                            yPosition += 5;
                        });
                    }
                });
            } else if (content) {
                const lines = doc.splitTextToSize(content, pageWidth);
                lines.forEach(line => {
                    checkPageBreak();
                    doc.text(line, marginLeft, yPosition);
                    yPosition += 5;
                });
            }
            
            yPosition += 8;
        }
        
        // Agregar header inicial
        addSimpleHeader();
        
        // Recopilar datos del formulario
        const formData = new FormData(document.getElementById('historiaClinicaForm'));
        const data = {};
        for (let [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Agregar secciones al PDF
        addSection('DATOS PERSONALES', {
            'Nombre y Apellido': data.nombreApellido,
            'Fecha de Nacimiento': data.fechaNacimiento,
            'Edad': data.edad,
            'DNI': data.dni,
            'Lugar de Nacimiento': data.lugarNacimiento,
            'Dirección Actual': data.direccionActual,
            'Teléfono': data.telefono
        });
        
        addSection('EQUIPO MÉDICO', data.equipoMedico);
        
        addSection('ANTECEDENTES', {
            'Antecedentes Familiares': data.antecedentesFamiliares,
            'Antecedentes Personales': data.antecedentesPersonales,
            'Intolerancias a Medicamentos': data.intoleranciaMedicamentos
        });
        
        addSection('INFORMACIÓN LABORAL Y EDUCATIVA', {
            'Ocupación': data.ocupacion,
            'Educación': data.educacion
        });
        
        addSection('VIDA COTIDIANA', {
            'Alimentación': data.alimentacion,
            'Sueño': data.sueno,
            'Actividad Física': data.actividadFisica
        });
        
        addSection('MEDICAMENTOS Y VACUNAS', {
            'Esquema de Vacunas': data.esquemaVacunas,
            'Indicaciones de Medicamentos': data.indicacionesMedicamentos
        });
        
        addSection('DATOS VITALES', {
            'TA': data.ta,
            'Temperatura': data.temperatura,
            'FR': data.fr,
            'FC': data.fc,
            'SAT O2': data.satO2
        });
        
        addSection('ANTROPOMETRÍA', {
            'Peso': data.peso + ' kg',
            'Talla': data.talla + ' cm',
            'IMC': data.imc,
            'PC': data.pc + ' cm'
        });
        
        addSection('EXAMEN POR APARATOS', {
            'Motricidad': data.motricidad,
            'Lenguaje': data.lenguaje,
            'Conducta Social': data.conductaSocial,
            'Piel y Faneras': data.pielFaneras,
            'Audición': data.audicion,
            'Visión': data.vision,
            'Pulmonar': data.pulmonar,
            'Cardíaco': data.cardiaco,
            'Abdominal': data.abdominal,
            'MMSS - MMII': data.mmssmmii
        });
        
        addSection('EVALUACIÓN FINAL', {
            'Evaluación General': data.evaluacionGeneral,
            'Recomendaciones': data.recomendaciones
        });
        
        // Firma
        checkPageBreak(30);
        doc.setFontSize(12);
        doc.setFont('helvetica', 'normal');
               doc.text('Milagros Quilici', pageWidth - 50, yPosition);
        doc.setFont('helvetica', 'bold');
        doc.text('MÉDICA', pageWidth - 50, yPosition + 10);
        
        // Agregar leyenda de Recrearte
        yPosition += 30;
        checkPageBreak(20);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor('#007bff');
        const centroText = 'RECREARTE CENTRO EDUCATIVO TERAPEUTICO';
        const direccionText = 'Buenos Aires 1950 - Funes - Santa Fe';
        const centroWidth = doc.getTextWidth(centroText);
        const direccionWidth = doc.getTextWidth(direccionText);
        doc.text(centroText, (pageWidth - centroWidth) / 2 + marginLeft, yPosition);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor('#000000');
        doc.text(direccionText, (pageWidth - direccionWidth) / 2 + marginLeft, yPosition + 8);

        
        // Guardar PDF
        const nombrePaciente = data.nombreApellido || 'Historia_Clinica';
        const fechaFormateada = data.fecha || new Date().toISOString().split('T')[0];
        doc.save(`${nombrePaciente}_${fechaFormateada}.pdf`);
        
    } catch (error) {
        console.error('Error generando PDF:', error);
        alert('Error al generar el PDF. Por favor, intente nuevamente.');
    }
}

// Limpiar formulario
function clearForm() {
    if (confirm('¿Está seguro de que desea limpiar todo el formulario? Esta acción no se puede deshacer.')) {
        document.getElementById('historiaClinicaForm').reset();
        
        // Limpiar campos específicos
        document.getElementById('edad').value = '';
        document.getElementById('imc').value = '';
        
        // Limpiar tabla de grupo familiar (dejar solo una fila)
        const tbody = document.getElementById('grupoFamiliarBody');
        tbody.innerHTML = `
            <tr>
                <td>1</td>
                <td><input type="text" name="familiar_nombre_1"></td>
                <td><input type="text" name="familiar_direccion_1"></td>
                <td><input type="tel" name="familiar_telefono_1"></td>
                <td><input type="text" name="familiar_referencia_1"></td>
                <td><button type="button" class="btn-remove" onclick="removeRow(this)">-</button></td>
            </tr>
        `;
        familiarRowCount = 1;
        
        // Limpiar localStorage
        localStorage.removeItem('historiaClinicaData');
        
        // Establecer fecha actual
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').value = today;
        
        // Volver a la primera sección
        showSection(1);
        
        alert('Formulario limpiado correctamente. Puede comenzar una nueva historia clínica.');
    }
}

// Función debounce para optimizar auto-guardado
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}
    </script>
</body>
</html>

